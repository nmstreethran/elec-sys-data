stages:
  - test_docs
  - deploy_docs
  - test_links
  - lint_python

# testing sphinx doc build
pages_test:
  stage: test_docs
  image: python:latest
  before_script:
    - pip install bokeh geopandas pydata-sphinx-theme
  script:
    - sphinx-build -b html docs public
  only:
    refs:
      - merge_requests
    changes:
      - docs/**/*
  except:
    - schedules

# building and deploying sphinx doc
pages:
  stage: deploy_docs
  image: python:latest
  before_script:
    - pip install bokeh geopandas pydata-sphinx-theme
  script:
    - sphinx-build -b html docs public
  artifacts:
    paths:
      - public
  only:
    refs:
      - master
    changes:
      - docs/**/*
  except:
    - schedules

# testing links in markdown and rst files
# https://github.com/dkhamsing/awesome_bot
links:
  stage: test_links
  image: ruby:latest
  before_script:
    - gem install awesome_bot
  script:
    - "awesome_bot --allow-dupe --skip-save-results --white-list
      doi.org,ml-elec-model.git,img.shields.io,\
      dnvgl.com/services/forecaster-94823,gridscientific.com/about-us
      `find . -name '*.md'` `find . -name '*.rst'`"
  only:
    refs:
      - schedules
      - merge_requests
    changes:
      - "**/*.rst"
      - "**/*.md"

# linting python scripts
lint:
  stage: lint_python
  image: python:latest
  before_script:
    - pip install -r requirements.txt
    - pip install flake8
  script:
    - flake8 scripts
    - flake8 docs/conf.py
  only:
    refs:
      - master
      - merge_requests
    changes:
      - scripts/**/*
      - docs/conf.py
  except:
    - schedules
