stages:
  - test
  - deploy

# linting Python scripts
linting:
  stage: test
  image: python:3.8
  before_script:
    - pip install -r requirements.txt
    - pip install flake8
  script:
    - flake8 scripts docs/conf.py
  only:
    refs:
      - merge_requests
  except:
    - schedules

# checking links in markdown and reStructuredText files
# https://github.com/dkhamsing/awesome_bot
links:
  stage: test
  image: ruby:latest
  before_script:
    - gem install awesome_bot
  script:
    - "awesome_bot --allow-dupe --skip-save-results --white-list
      bkg.bund.de,doi.org,dnvgl.com/services/forecaster-94823,\
      elia.be,ml-elec-model.git `find . -name '*.md'` `find . -name '*.rst'`"
  only:
    refs:
      - schedules
      - merge_requests

# testing Sphinx doc build
pages_test:
  stage: test
  image: python:3.8
  before_script:
    - pip install bokeh geopandas pydata-sphinx-theme
  script:
    - 'sed
      -e "s/nithiya.gitlab.io\/ml-elec-model\//\`& <.\/index.html>\`__/"
      -e "1,3d" README.rst > docs/readme.rst'
    - sphinx-build -b html docs public
  only:
    refs:
      - merge_requests
  except:
    - schedules

# building and deploying Sphinx doc
pages:
  stage: deploy
  image: python:3.8
  before_script:
    - 'sed
      -e "s/nithiya.gitlab.io\/ml-elec-model\//\`& <.\/index.html>\`__/"
      -e "1,3d" README.rst > docs/readme.rst'
    - pip install bokeh geopandas pydata-sphinx-theme
  script:
    - sphinx-build -b html docs public
  artifacts:
    paths:
      - public
  only:
    refs:
      - master
  except:
    - schedules
